# 84. Elastic Load Balancer - Connection Draining

## ğŸ”„ **Connection Draining / Deregistration Delay â€“ Quáº£n lÃ½ káº¿t ná»‘i khi há»§y Ä‘Äƒng kÃ½ instance**

---

### ğŸ“Œ **Äá»‹nh nghÄ©a:**

* **Connection Draining** lÃ  tÃ­nh nÄƒng quan trá»ng giÃºp Ä‘áº£m báº£o **cÃ¡c request Ä‘ang xá»­ lÃ½ (in-flight requests)** khÃ´ng bá»‹ giÃ¡n Ä‘oáº¡n khi má»™t **EC2 instance** bá»‹ **deregister** hoáº·c bá»‹ Ä‘Ã¡nh dáº¥u **unhealthy**.
* TÃ¹y vÃ o loáº¡i Load Balancer:

  * **Classic Load Balancer (CLB)** gá»i lÃ  **Connection Draining**
  * **Application Load Balancer (ALB)** vÃ  **Network Load Balancer (NLB)** gá»i lÃ  **Deregistration Delay**

---

### ğŸ§  **Má»¥c Ä‘Ã­ch:**

* Khi má»™t instance báº¯t Ä‘áº§u Ä‘Æ°á»£c **deregister**:

  * **ELB (Elastic Load Balancer)** sáº½ **ngá»«ng gá»­i request má»›i** Ä‘áº¿n instance Ä‘Ã³.
  * Instance váº«n Ä‘Æ°á»£c **giá»¯ káº¿t ná»‘i** vá»›i cÃ¡c request **Ä‘ang xá»­ lÃ½**, cho Ä‘áº¿n khi hoÃ n táº¥t.
  * Sau khi hoÃ n táº¥t cÃ¡c request, cÃ¡c **káº¿t ná»‘i sáº½ bá»‹ Ä‘Ã³ng** vÃ  instance chÃ­nh thá»©c bá»‹ loáº¡i khá»i load balancer.

---

### ğŸ“Š **SÆ¡ Ä‘á»“ minh há»a (diá»…n giáº£i):**

* CÃ³ 3 EC2 instances, má»™t trong sá»‘ Ä‘Ã³ Ä‘Æ°á»£c Ä‘áº·t vÃ o tráº¡ng thÃ¡i **draining**.
* Nhá»¯ng ngÆ°á»i dÃ¹ng Ä‘ang káº¿t ná»‘i Ä‘áº¿n instance Ä‘Ã³ váº«n cÃ³ thá»i gian Ä‘á»ƒ hoÃ n thÃ nh session.
* NgÆ°á»i dÃ¹ng **má»›i** sáº½ Ä‘Æ°á»£c ELB tá»± Ä‘á»™ng **chuyá»ƒn hÆ°á»›ng** Ä‘áº¿n cÃ¡c instance khÃ¡c cÃ²n hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng.

---

### âš™ï¸ **Cáº¥u hÃ¬nh Connection Draining / Deregistration Delay:**

* **Thá»i gian tÃ¹y chá»‰nh**: tá»« **1 Ä‘áº¿n 3.600 giÃ¢y**

  * **Máº·c Ä‘á»‹nh**: 300 giÃ¢y (**5 phÃºt**)
  * **GiÃ¡ trá»‹ = 0**: **vÃ´ hiá»‡u hÃ³a** tÃ­nh nÄƒng nÃ y (khÃ´ng cÃ³ thá»i gian chá», instance bá»‹ remove ngay láº­p tá»©c)

---

### ğŸ“ˆ **Chiáº¿n lÆ°á»£c thiáº¿t láº­p tÃ¹y theo loáº¡i request:**

* Náº¿u **request ngáº¯n** (dÆ°á»›i 1 giÃ¢y):

  * CÃ³ thá»ƒ giáº£m thá»i gian **draining** xuá»‘ng cÃ²n **30 giÃ¢y** hoáº·c tháº¥p hÆ¡n Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ thay tháº¿ instance.
* Náº¿u **request dÃ i** (upload lá»›n, long-lived connections):

  * NÃªn tÄƒng thá»i gian **draining** Ä‘á»ƒ trÃ¡nh giÃ¡n Ä‘oáº¡n, vÃ­ dá»¥ lÃªn Ä‘áº¿n vÃ i phÃºt.

---

### âœ… **TÃ³m táº¯t:**

* **Connection Draining / Deregistration Delay** giÃºp **Ä‘áº£m báº£o tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng** khÃ´ng bá»‹ giÃ¡n Ä‘oáº¡n khi má»™t instance rá»i khá»i há»‡ thá»‘ng.
* Cáº¥u hÃ¬nh há»£p lÃ½ sáº½ **tá»‘i Æ°u hiá»‡u suáº¥t vÃ  Ä‘á»™ á»•n Ä‘á»‹nh** khi scale hoáº·c thay tháº¿ EC2 instances trong kiáº¿n trÃºc dÃ¹ng ELB.

---

