# 80. Elastic Load Balancer - Sticky Sessions

## ğŸ” **Sticky Sessions (Session Affinity)** trong Elastic Load Balancer (ELB)

### ğŸ“Œ **Sticky Sessions lÃ  gÃ¬?**

* LÃ  **cÆ¡ cháº¿ gáº¯n káº¿t phiÃªn lÃ m viá»‡c (session)** giá»¯a **client vÃ  má»™t backend cá»¥ thá»ƒ**, Ä‘á»ƒ khi **client gá»­i nhiá»u request**, táº¥t cáº£ sáº½ Ä‘Æ°á»£c chuyá»ƒn tá»›i **cÃ¹ng má»™t EC2 instance** phÃ­a sau **Load Balancer**.
* Máº·c Ä‘á»‹nh, **Application Load Balancer (ALB)** sáº½ **phÃ¢n phá»‘i Ä‘á»u (round-robin)** cÃ¡c request Ä‘áº¿n nhiá»u instance.

---

### ğŸ’¡ **Khi nÃ o nÃªn dÃ¹ng Sticky Sessions?**

* Khi á»©ng dá»¥ng cáº§n lÆ°u **tráº¡ng thÃ¡i phiÃªn (session state)** nhÆ°:

  * **Dá»¯ liá»‡u Ä‘Äƒng nháº­p**
  * **Giá» hÃ ng**
  * **ThÃ´ng tin ngÆ°á»i dÃ¹ng táº¡m thá»i**

---

### ğŸ–¥ï¸ **CÃ¡c Load Balancer há»— trá»£:**

* **Classic Load Balancer (CLB)**
* **Application Load Balancer (ALB)**
* **Network Load Balancer (NLB)**

---

### ğŸª **CÃ¡ch hoáº¡t Ä‘á»™ng cá»§a Sticky Sessions:**

* **Client nháº­n Cookie tá»« Load Balancer**, trong Ä‘Ã³ cÃ³ thÃ´ng tin liÃªn káº¿t phiÃªn.
* Khi gá»­i láº¡i request, client sáº½ **gá»­i cookie** => Load Balancer biáº¿t pháº£i chuyá»ƒn Ä‘áº¿n **cÃ¹ng má»™t backend EC2 instance**.
* **Khi cookie háº¿t háº¡n**, phiÃªn cÃ³ thá»ƒ Ä‘Æ°á»£c chuyá»ƒn sang má»™t instance khÃ¡c.

---

### ğŸ“¦ **CÃ³ 2 loáº¡i Cookie dÃ¹ng cho Sticky Sessions:**

| Loáº¡i Cookie                  | Táº¡o bá»Ÿi            | Äáº·c Ä‘iá»ƒm chÃ­nh                                               | TÃªn Cookie máº·c Ä‘á»‹nh                |
| ---------------------------- | ------------------ | ------------------------------------------------------------ | ---------------------------------- |
| **Application-based Cookie** | **á»¨ng dá»¥ng (app)** | - TÃ¹y chá»‰nh ná»™i dung<br>- Cáº§n khai bÃ¡o **cookie name** riÃªng | **TÃ¹y Ã½**, khÃ´ng dÃ¹ng `AWSALB`,... |
| **Duration-based Cookie**    | **Load Balancer**  | - Cookie cÃ³ thá»i gian sá»‘ng cá»‘ Ä‘á»‹nh (1s Ä‘áº¿n 7 ngÃ y)           | `AWSALB` (ALB), `AWSELB` (CLB),... |

* **LÆ°u Ã½**: KhÃ´ng Ä‘Æ°á»£c dÃ¹ng cÃ¡c tÃªn cookie **dÃ nh riÃªng cho AWS** nhÆ° `AWSALB`, `AWSALBAPP`, `AWSALBTG`.

---

### âš™ï¸ **CÃ¡ch báº­t Sticky Sessions (trÃªn ALB):**

1. Truy cáº­p vÃ o **Target Group** cá»§a ALB.
2. Chá»n **Actions > Edit Attributes**.
3. **Báº­t Stickiness**.
4. Chá»n loáº¡i:

   * **Load Balancer generated cookie**

     * Äáº·t thá»i gian háº¿t háº¡n (1 giÃ¢y Ä‘áº¿n 7 ngÃ y).
   * **Application-based cookie**

     * Tá»± khai bÃ¡o tÃªn cookie (vÃ­ dá»¥: `MYCUSTOMCOOKIEAPP`).

---

### ğŸ” **Kiá»ƒm tra Cookie hoáº¡t Ä‘á»™ng:**

* Má»Ÿ **Web Developer Tools** (trÃªn Chrome/Firefox).
* Chuyá»ƒn sang tab **Network** vÃ  quan sÃ¡t:

  * **Response Cookie** Ä‘Æ°á»£c Load Balancer tráº£ vá» (cÃ³ expiry).
  * **Request Cookie** Ä‘Æ°á»£c gá»­i ngÆ°á»£c láº¡i tá»« browser.

---

### âš ï¸ **LÆ°u Ã½ khi dÃ¹ng Sticky Sessions:**

* CÃ³ thá»ƒ gÃ¢y **máº¥t cÃ¢n báº±ng táº£i (load imbalance)** náº¿u cÃ³ client gá»­i quÃ¡ nhiá»u request Ä‘áº¿n má»™t instance duy nháº¥t.
* NÃªn cÃ¢n nháº¯c dÃ¹ng thÃªm **session replication hoáº·c external session store** náº¿u á»©ng dá»¥ng Ä‘Ã²i há»i tÃ­nh sáºµn sÃ ng cao.

---

### âœ… **TÃ³m táº¯t kiáº¿n thá»©c chÃ­nh:**

| Thuá»™c tÃ­nh           | Ghi chÃº                                                   |
| -------------------- | --------------------------------------------------------- |
| TÃªn khÃ¡i niá»‡m        | **Sticky Sessions / Session Affinity**                    |
| Má»¥c tiÃªu             | Gáº¯n káº¿t client vá»›i cÃ¹ng má»™t backend                       |
| DÃ¹ng cookie          | CÃ³, cookie dÃ¹ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh phiÃªn                         |
| CÃ¡c loáº¡i cookie      | **Application-based**, **Duration-based**                 |
| Load Balancer há»— trá»£ | **ALB**, **CLB**, **NLB**                                 |
| Rá»§i ro               | **Load imbalance** náº¿u nhiá»u client truy cáº­p má»™t instance |

---
